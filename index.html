<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal del Trabajador</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-blue-50 flex items-center justify-center min-h-screen">

    <div id="login-section" class="bg-white p-8 rounded-lg shadow-md w-96">
        <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Acceso Trabajador</h2>
        <input type="text" id="usuario" placeholder="Usuario" class="w-full mb-4 p-2 border rounded">
        <input type="password" id="password" placeholder="Contraseña" class="w-full mb-6 p-2 border rounded">
        <button onclick="login()" class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700">Entrar</button>
    </div>

    <div id="form-section" class="bg-white p-8 rounded-lg shadow-md w-full max-w-md hidden">
        <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Registro Físico</h2>
        
        <label class="block text-gray-700 mb-2">Altura (en metros, ej: 1.75)</label>
        <input type="number" step="0.01" id="altura" class="w-full mb-4 p-2 border rounded">
        
        <label class="block text-gray-700 mb-2">Peso (en kg, ej: 70.5)</label>
        <input type="number" step="0.1" id="peso" class="w-full mb-6 p-2 border rounded">

        <label class="block text-gray-700 mb-2">Firma aquí:</label>
        <canvas id="pizarra" width="350" height="150" class="border rounded bg-gray-50 mb-4 cursor-crosshair"></canvas>
        <button onclick="limpiarFirma()" class="text-sm text-red-500 mb-6">Limpiar Firma</button>

        <button onclick="guardarFormulario()" class="w-full bg-green-600 text-white p-2 rounded hover:bg-green-700">Firmar y Enviar</button>
    </div>

    <script>
        let usuarioActualId = null;

        // --- Lógica del Canvas (Firma) ---
        const canvas = document.getElementById('pizarra');
        const ctx = canvas.getContext('2d');
        let dibujando = false;

        canvas.addEventListener('mousedown', (e) => { dibujando = true; ctx.beginPath(); ctx.moveTo(e.offsetX, e.offsetY); });
        canvas.addEventListener('mousemove', (e) => { if(dibujando) { ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); } });
        canvas.addEventListener('mouseup', () => { dibujando = false; });
        canvas.addEventListener('mouseout', () => { dibujando = false; });

        function limpiarFirma() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // --- Conexión con Backend ---
        async function login() {
            const usuario = document.getElementById('usuario').value;
            const password = document.getElementById('password').value;

            const response = await fetch('http://localhost:3000/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ usuario, password })
            });
            const data = await response.json();

            if (data.success) {
                usuarioActualId = data.usuarioId;
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('form-section').classList.remove('hidden');
            } else {
                alert('Credenciales incorrectas (Usa: trabajador1 / 1234)');
            }
        }

        async function guardarFormulario() {
            const altura = document.getElementById('altura').value;
            const peso = document.getElementById('peso').value;
            // Convertimos la firma a una imagen en Base64 para guardarla en la base de datos
            const firma = canvas.toDataURL('image/png'); 

            if (!altura || !peso) return alert('Llena todos los campos');

            const response = await fetch('http://localhost:3000/guardar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ usuarioId: usuarioActualId, altura, peso, firma })
            });
            const data = await response.json();

            if (data.success) {
                alert(`¡Guardado! Tu IMC calculado por Python es: ${data.imc}`);
                location.reload(); // Recargar para limpiar
            }
        }
    </script>
</body>
</html>