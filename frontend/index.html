<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Permisos de Trabajo</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --primary:    #1a56db;
      --primary-dk: #1240a8;
      --bg:         #f1f5f9;
      --card:       #ffffff;
      --text:       #1e293b;
      --muted:      #64748b;
      --border:     #cbd5e1;
      --danger:     #ef4444;
      --success:    #22c55e;
      --radius:     10px;
    }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: 0 4px 24px rgba(0,0,0,.10);
      width: 100%;
      max-width: 520px;
      padding: 40px 36px;
      animation: fadeIn .35s ease;
    }
    @keyframes fadeIn { from { opacity:0; transform:translateY(16px); } to { opacity:1; transform:none; } }
    .card-header { text-align: center; margin-bottom: 28px; }
    .card-header .logo {
      width: 56px; height: 56px;
      background: var(--primary);
      border-radius: 14px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 14px;
    }
    .card-header .logo svg { width:30px; height:30px; fill:#fff; }
    .card-header h1 { font-size: 1.35rem; font-weight: 700; color: var(--text); }
    .card-header p  { font-size: .875rem; color: var(--muted); margin-top: 4px; }
    .form-group { margin-bottom: 18px; }
    .form-group label {
      display: block;
      font-size: .8125rem;
      font-weight: 600;
      color: var(--muted);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: .04em;
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 10px 14px;
      border: 1.5px solid var(--border);
      border-radius: 8px;
      font-size: .9375rem;
      color: var(--text);
      background: #fff;
      transition: border-color .2s, box-shadow .2s;
      outline: none;
      font-family: inherit;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(26,86,219,.12);
    }
    .form-group textarea { resize: vertical; min-height: 80px; }
    .input-icon { position:relative; }
    .input-icon input { padding-left: 40px; }
    .input-icon .icon {
      position:absolute; left:12px; top:50%; transform:translateY(-50%);
      color: var(--muted); pointer-events:none;
    }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
    .btn {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: background .2s, transform .1s;
    }
    .btn:active { transform: scale(.98); }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: var(--primary-dk); }
    .btn-primary:disabled { background: #93c5fd; cursor: not-allowed; }
    .btn-secondary { background: #e2e8f0; color: var(--text); margin-top: 8px; }
    .btn-secondary:hover { background: #cbd5e1; }
    .alert {
      padding: 10px 14px;
      border-radius: 8px;
      font-size: .875rem;
      margin-bottom: 16px;
      display: none;
    }
    .alert.error   { background:#fee2e2; color:#b91c1c; border:1px solid #fca5a5; display:block; }
    .alert.success { background:#dcfce7; color:#15803d; border:1px solid #86efac; display:block; }
    .divider { border:none; border-top:1px solid var(--border); margin:20px 0; }
    .badge {
      display:inline-block;
      background:#eff6ff;
      color:var(--primary);
      font-size:.75rem;
      font-weight:700;
      padding:2px 8px;
      border-radius:99px;
      margin-left:6px;
    }
    .spinner {
      display:inline-block;
      width:16px; height:16px;
      border:2px solid rgba(255,255,255,.4);
      border-top-color:#fff;
      border-radius:50%;
      animation:spin .6s linear infinite;
      vertical-align:middle;
      margin-right:6px;
    }
    @keyframes spin { to { transform:rotate(360deg); } }
    .hidden { display: none !important; }
    .user-bar {
      display:flex; align-items:center; justify-content:space-between;
      background:#eff6ff; border-radius:8px; padding:10px 14px;
      margin-bottom:20px; font-size:.875rem;
    }
    .user-bar strong { color:var(--primary); }
    .user-bar button {
      background:none; border:none; color:var(--danger);
      font-size:.8125rem; font-weight:600; cursor:pointer;
    }
    .user-bar button:hover { text-decoration:underline; }
    .selector-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 24px;
    }
    .selector-btn {
      padding: 14px;
      border: 2px solid var(--border);
      border-radius: 8px;
      background: #fff;
      cursor: pointer;
      transition: all .2s;
      text-align: center;
      font-weight: 600;
      font-size: .9rem;
      color: var(--muted);
    }
    .selector-btn:hover { border-color: var(--primary); color: var(--primary); }
    .selector-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }

    /* Canvas de firma digital */
    .firma-container {
      border: 1.5px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      background: #fff;
    }
    .firma-container canvas {
      display: block;
      width: 100%;
      height: 120px;
      cursor: crosshair;
      touch-action: none;
      background: #fff;
    }
    .firma-toolbar {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      padding: 6px 10px;
      background: #f8fafc;
      border-top: 1px solid var(--border);
    }
    .firma-toolbar button {
      padding: 4px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: #fff;
      font-size: .8rem;
      cursor: pointer;
      color: var(--muted);
      font-weight: 600;
    }
    .firma-toolbar button:hover { border-color: var(--primary); color: var(--primary); }
    .firma-hint { font-size: .75rem; color: var(--muted); margin-top: 4px; }
  </style>
</head>
<body>
<div class="card" id="app">

  <!-- LOGIN -->
  <div id="screen-login">
    <div class="card-header">
      <div class="logo">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2a9 9 0 0 1 9 9v1H3v-1a9 9 0 0 1 9-9zm-9 11h18v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1zm2 4h14v1a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1v-1z"/>
        </svg>
      </div>
      <h1>Permisos de Trabajo</h1>
      <p>Inicia sesion para continuar</p>
    </div>
    <div id="login-alert" class="alert"></div>
    <form id="form-login" novalidate>
      <div class="form-group">
        <label for="login-user">Usuario</label>
        <div class="input-icon">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/></svg>
          </span>
          <input type="text" id="login-user" placeholder="Ingresa tu usuario" autocomplete="username" required />
        </div>
      </div>
      <div class="form-group">
        <label for="login-pass">Contrasena</label>
        <div class="input-icon">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
          </span>
          <input type="password" id="login-pass" placeholder="Ingresa tu contrasena" autocomplete="current-password" required />
        </div>
      </div>
      <button type="submit" class="btn btn-primary" id="btn-login">Iniciar sesion</button>
    </form>
    <hr class="divider" />
    <p style="text-align:center;font-size:.8rem;color:var(--muted);">
      Credenciales de prueba: <strong>admin</strong> / <strong>1234</strong>
    </p>
  </div>

  <!-- SELECTOR DE FORMULARIOS -->
  <div id="screen-selector" class="hidden">
    <div class="user-bar">
      <span>Bienvenido, <strong id="user-name-display-selector"></strong></span>
      <button id="btn-logout-selector">Cerrar sesion</button>
    </div>
    <div class="card-header" style="margin-bottom:20px;">
      <h1>Selecciona un Formulario</h1>
      <p>Elige el tipo de documento que deseas generar</p>
    </div>
    <div class="selector-container">
      <button type="button" class="selector-btn active" id="btn-select-alturas">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin: 0 auto 8px; display: block;">
          <path d="M12 2v20M2 12h20"/>
        </svg>
        Permiso de Alturas
      </button>
      <button type="button" class="selector-btn" id="btn-select-asistencia">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin: 0 auto 8px; display: block;">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2M12 3a4 4 0 1 0 0 8 4 4 0 0 0 0-8z"/>
        </svg>
        Asistencia
      </button>
    </div>
  </div>

  <!-- FORMULARIO DE ALTURAS -->
  <div id="screen-form-alturas" class="hidden">
    <div class="user-bar">
      <span>Bienvenido, <strong id="user-name-display-alturas"></strong></span>
      <button id="btn-back-alturas">Volver</button>
    </div>
    <div class="card-header" style="margin-bottom:20px;">
      <h1>Permiso de Trabajo en Alturas <span class="badge">Excel</span></h1>
      <p>Completa los campos y descarga el documento generado</p>
    </div>
    <div id="form-alert-alturas" class="alert"></div>
    <form id="form-permiso-alturas" novalidate>
      <div class="row">
        <div class="form-group">
          <label for="f-fecha">Fecha</label>
          <input type="date" id="f-fecha" required />
        </div>
        <div class="form-group">
          <label for="f-hora">Hora de inicio</label>
          <input type="time" id="f-hora" required />
        </div>
      </div>
      <div class="form-group">
        <label for="f-area">Area / Ubicacion</label>
        <input type="text" id="f-area" placeholder="Ej: Torre A, Piso 3" required />
      </div>
      <div class="form-group">
        <label for="f-altura">Altura maxima (metros)</label>
        <input type="number" id="f-altura" placeholder="Ej: 15" min="0" required />
      </div>

      <!-- FIRMA DIGITAL CON CANVAS -->
      <div class="form-group">
        <label>Firma del responsable</label>
        <div class="firma-container">
          <canvas id="firma-canvas" width="480" height="120"></canvas>
          <div class="firma-toolbar">
            <button type="button" id="btn-limpiar-firma">Limpiar</button>
          </div>
        </div>
        <p class="firma-hint">Dibuja tu firma con el mouse o dedo en el area de arriba.</p>
      </div>

      <button type="submit" class="btn btn-primary" id="btn-generar-alturas">
        Generar y descargar Excel
      </button>
    </form>
  </div>

  <!-- FORMULARIO DE ASISTENCIA -->
  <div id="screen-form-asistencia" class="hidden">
    <div class="user-bar">
      <span>Bienvenido, <strong id="user-name-display-asistencia"></strong></span>
      <button id="btn-back-asistencia">Volver</button>
    </div>
    <div class="card-header" style="margin-bottom:20px;">
      <h1>Registro de Asistencia <span class="badge">Nuevo</span></h1>
      <p>Completa los campos de asistencia</p>
    </div>
    <div id="form-alert-asistencia" class="alert"></div>
    <form id="form-asistencia" novalidate>
      <div class="row">
        <div class="form-group">
          <label for="a-fecha">Fecha</label>
          <input type="date" id="a-fecha" required />
        </div>
        <div class="form-group">
          <label for="a-hora-entrada">Hora de entrada</label>
          <input type="time" id="a-hora-entrada" required />
        </div>
      </div>
      <div class="row">
        <div class="form-group">
          <label for="a-hora-salida">Hora de salida</label>
          <input type="time" id="a-hora-salida" required />
        </div>
        <div class="form-group">
          <label for="a-trabajador">Nombre del trabajador</label>
          <input type="text" id="a-trabajador" placeholder="Ej: Juan Perez" required />
        </div>
      </div>
      <div class="form-group">
        <label for="a-departamento">Departamento</label>
        <input type="text" id="a-departamento" placeholder="Ej: Mantenimiento" required />
      </div>
      <div class="form-group">
        <label for="a-observaciones">Observaciones</label>
        <textarea id="a-observaciones" placeholder="Notas adicionales (opcional)"></textarea>
      </div>
      <button type="submit" class="btn btn-primary" id="btn-generar-asistencia">
        Guardar asistencia
      </button>
    </form>
  </div>

</div>

<script>
  // ============================================================
  // Configuracion
  // ============================================================
  var API_BASE = 'http://localhost:5205';
  var currentUser = null;

  // ============================================================
  // Manejo del token JWT
  // Se guarda en localStorage para que funcione tanto desde file://
  // como desde un servidor HTTP. El token se envia como header
  // Authorization: Bearer <token> en cada peticion autenticada.
  // ============================================================
  function getToken()        { return localStorage.getItem('jwt_token'); }
  function setToken(t)       { localStorage.setItem('jwt_token', t); }
  function clearToken()      { localStorage.removeItem('jwt_token'); localStorage.removeItem('jwt_user'); }
  function getStoredUser()   { try { return JSON.parse(localStorage.getItem('jwt_user')); } catch(e) { return null; } }
  function setStoredUser(u)  { localStorage.setItem('jwt_user', JSON.stringify(u)); }

  // Construye los headers para peticiones autenticadas
  function authHeaders(extra) {
    var h = Object.assign({ 'Content-Type': 'application/json' }, extra || {});
    var token = getToken();
    if (token) h['Authorization'] = 'Bearer ' + token;
    return h;
  }

  // ============================================================
  // Utilidades DOM
  // ============================================================
  function gid(id) { return document.getElementById(id); }

  function showAlert(id, msg, type) {
    var el = gid(id);
    el.textContent = msg;
    el.className = 'alert ' + type;
  }
  function hideAlert(id) {
    var el = gid(id);
    el.className = 'alert';
    el.textContent = '';
  }
  function showScreen(name) {
    gid('screen-login').classList.toggle('hidden', name !== 'login');
    gid('screen-selector').classList.toggle('hidden', name !== 'selector');
    gid('screen-form-alturas').classList.toggle('hidden', name !== 'alturas');
    gid('screen-form-asistencia').classList.toggle('hidden', name !== 'asistencia');
  }
  function setUserDisplay(displayName) {
    gid('user-name-display-selector').textContent   = displayName;
    gid('user-name-display-alturas').textContent    = displayName;
    gid('user-name-display-asistencia').textContent = displayName;
  }

  // ============================================================
  // Canvas de Firma Digital
  // Genera Base64 PNG que el backend inyecta con AddPicture()
  // ============================================================
  var firmaCanvas = gid('firma-canvas');
  var firmaCtx    = firmaCanvas.getContext('2d');
  var firmaActiva = false;
  var firmaVacia  = true;

  firmaCtx.strokeStyle = '#1e293b';
  firmaCtx.lineWidth   = 2.5;
  firmaCtx.lineCap     = 'round';
  firmaCtx.lineJoin    = 'round';

  function firmaGetPos(e) {
    var rect   = firmaCanvas.getBoundingClientRect();
    var scaleX = firmaCanvas.width  / rect.width;
    var scaleY = firmaCanvas.height / rect.height;
    var src    = e.touches ? e.touches[0] : e;
    return { x: (src.clientX - rect.left) * scaleX, y: (src.clientY - rect.top) * scaleY };
  }

  firmaCanvas.addEventListener('mousedown', function(e) {
    firmaActiva = true; firmaVacia = false;
    var p = firmaGetPos(e);
    firmaCtx.beginPath(); firmaCtx.moveTo(p.x, p.y);
  });
  firmaCanvas.addEventListener('mousemove', function(e) {
    if (!firmaActiva) return;
    var p = firmaGetPos(e);
    firmaCtx.lineTo(p.x, p.y); firmaCtx.stroke();
  });
  firmaCanvas.addEventListener('mouseup',    function() { firmaActiva = false; });
  firmaCanvas.addEventListener('mouseleave', function() { firmaActiva = false; });

  firmaCanvas.addEventListener('touchstart', function(e) {
    e.preventDefault(); firmaActiva = true; firmaVacia = false;
    var p = firmaGetPos(e);
    firmaCtx.beginPath(); firmaCtx.moveTo(p.x, p.y);
  }, { passive: false });
  firmaCanvas.addEventListener('touchmove', function(e) {
    e.preventDefault();
    if (!firmaActiva) return;
    var p = firmaGetPos(e);
    firmaCtx.lineTo(p.x, p.y); firmaCtx.stroke();
  }, { passive: false });
  firmaCanvas.addEventListener('touchend', function() { firmaActiva = false; });

  gid('btn-limpiar-firma').addEventListener('click', function() {
    firmaCtx.clearRect(0, 0, firmaCanvas.width, firmaCanvas.height);
    firmaVacia = true;
  });

  function getFirmaBase64() {
    return firmaVacia ? null : firmaCanvas.toDataURL('image/png');
  }

  // ============================================================
  // Autenticacion JWT
  // El token se guarda en localStorage y se envia como header
  // Authorization: Bearer <token> en cada peticion.
  // ============================================================
  function tryRestoreSession() {
    var token = getToken();
    var user  = getStoredUser();
    if (token && user) {
      currentUser = user;
      setUserDisplay(user.displayName);
      showScreen('selector');
    } else {
      showScreen('login');
    }
  }

  gid('form-login').addEventListener('submit', async function(e) {
    e.preventDefault();
    hideAlert('login-alert');
    var btn = gid('btn-login');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span>Ingresando...';

    try {
      var res = await fetch(API_BASE + '/api/auth/login', {
        method:  'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          username: gid('login-user').value.trim(),
          password: gid('login-pass').value
        })
      });

      if (!res.ok) {
        var err = await res.json().catch(function() { return { message: 'Credenciales incorrectas.' }; });
        throw new Error(err.message || 'Error de autenticacion');
      }

      var data = await res.json();

      // Guardar token y datos del usuario en localStorage
      setToken(data.token);
      currentUser = { username: data.username, displayName: data.displayName };
      setStoredUser(currentUser);

      setUserDisplay(data.displayName);
      showScreen('selector');
    } catch (err) {
      var msg = err.message;
      if (msg.includes('fetch') || msg.includes('NetworkError') || msg.includes('Failed')) {
        msg = 'No se pudo conectar al servidor en ' + API_BASE + '. Verifica que el backend este corriendo con "dotnet run".';
      }
      showAlert('login-alert', msg, 'error');
    } finally {
      btn.disabled = false;
      btn.innerHTML = 'Iniciar sesion';
    }
  });

  function logout() {
    clearToken();
    currentUser = null;
    gid('form-login').reset();
    gid('form-permiso-alturas').reset();
    gid('form-asistencia').reset();
    firmaCtx.clearRect(0, 0, firmaCanvas.width, firmaCanvas.height);
    firmaVacia = true;
    hideAlert('form-alert-alturas');
    hideAlert('form-alert-asistencia');
    showScreen('login');
  }

  gid('btn-logout-selector').addEventListener('click', logout);

  // ============================================================
  // Navegacion entre pantallas
  // ============================================================
  gid('btn-select-alturas').addEventListener('click', function() {
    gid('btn-select-alturas').classList.add('active');
    gid('btn-select-asistencia').classList.remove('active');
    gid('f-fecha').value = new Date().toISOString().split('T')[0];
    showScreen('alturas');
  });
  gid('btn-select-asistencia').addEventListener('click', function() {
    gid('btn-select-asistencia').classList.add('active');
    gid('btn-select-alturas').classList.remove('active');
    gid('a-fecha').value = new Date().toISOString().split('T')[0];
    showScreen('asistencia');
  });
  gid('btn-back-alturas').addEventListener('click',    function() { showScreen('selector'); });
  gid('btn-back-asistencia').addEventListener('click', function() { showScreen('selector'); });

  // ============================================================
  // Formulario Alturas
  // ============================================================
  gid('form-permiso-alturas').addEventListener('submit', async function(e) {
    e.preventDefault();
    hideAlert('form-alert-alturas');
    var btn = gid('btn-generar-alturas');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span>Generando...';

    var payload = {
      fecha:                    gid('f-fecha').value,
      horaInicio:               gid('f-hora').value,
      area:                     gid('f-area').value,
      alturaMaxima:             gid('f-altura').value,
      imgFirmaResponsableTarea: getFirmaBase64()
    };

    try {
      var response = await fetch(API_BASE + '/api/documentos/generar-permiso', {
        method:  'POST',
        headers: authHeaders(),
        body:    JSON.stringify(payload)
      });

      if (response.status === 401) {
        showAlert('form-alert-alturas', 'Sesion expirada. Redirigiendo al login...', 'error');
        setTimeout(logout, 2000);
        return;
      }
      if (!response.ok) {
        var errText = await response.text();
        throw new Error(errText || 'Error ' + response.status);
      }

      var blob = await response.blob();
      var url  = window.URL.createObjectURL(blob);
      var a    = document.createElement('a');
      a.href = url; a.download = 'Permiso_Alturas_Completado.xlsx';
      document.body.appendChild(a); a.click(); a.remove();
      window.URL.revokeObjectURL(url);
      showAlert('form-alert-alturas', 'Documento generado y descargado correctamente.', 'success');
    } catch (err) {
      showAlert('form-alert-alturas',
        'Error al conectar con el servidor (' + API_BASE + '). Detalle: ' + err.message, 'error');
    } finally {
      btn.disabled = false;
      btn.innerHTML = 'Generar y descargar Excel';
    }
  });

  // ============================================================
  // Formulario Asistencia
  // ============================================================
  gid('form-asistencia').addEventListener('submit', async function(e) {
    e.preventDefault();
    hideAlert('form-alert-asistencia');
    var btn = gid('btn-generar-asistencia');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span>Guardando...';
    try {
      showAlert('form-alert-asistencia', 'Asistencia registrada correctamente.', 'success');
      gid('form-asistencia').reset();
      gid('a-fecha').value = new Date().toISOString().split('T')[0];
    } catch (err) {
      showAlert('form-alert-asistencia', 'Error: ' + err.message, 'error');
    } finally {
      btn.disabled = false;
      btn.innerHTML = 'Guardar asistencia';
    }
  });

  // ============================================================
  // Inicio: restaurar sesion desde localStorage
  // ============================================================
  tryRestoreSession();
</script>
</body>
</html>
