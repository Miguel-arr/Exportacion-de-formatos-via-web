<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Permisos de Trabajo</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --primary:    #1a56db;
      --primary-dk: #1240a8;
      --bg:         #f1f5f9;
      --card:       #ffffff;
      --text:       #1e293b;
      --muted:      #64748b;
      --border:     #cbd5e1;
      --danger:     #ef4444;
      --success:    #22c55e;
      --radius:     10px;
    }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: 0 4px 24px rgba(0,0,0,.10);
      width: 100%;
      max-width: 480px;
      padding: 40px 36px;
      animation: fadeIn .35s ease;
    }
    @keyframes fadeIn { from { opacity:0; transform:translateY(16px); } to { opacity:1; transform:none; } }
    .card-header { text-align: center; margin-bottom: 28px; }
    .card-header .logo {
      width: 56px; height: 56px;
      background: var(--primary);
      border-radius: 14px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 14px;
    }
    .card-header .logo svg { width:30px; height:30px; fill:#fff; }
    .card-header h1 { font-size: 1.35rem; font-weight: 700; color: var(--text); }
    .card-header p  { font-size: .875rem; color: var(--muted); margin-top: 4px; }
    .form-group { margin-bottom: 18px; }
    .form-group label {
      display: block;
      font-size: .8125rem;
      font-weight: 600;
      color: var(--muted);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: .04em;
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 10px 14px;
      border: 1.5px solid var(--border);
      border-radius: 8px;
      font-size: .9375rem;
      color: var(--text);
      background: #fff;
      transition: border-color .2s, box-shadow .2s;
      outline: none;
      font-family: inherit;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(26,86,219,.12);
    }
    .form-group textarea { resize: vertical; min-height: 80px; }
    .input-icon { position:relative; }
    .input-icon input { padding-left: 40px; }
    .input-icon .icon {
      position:absolute; left:12px; top:50%; transform:translateY(-50%);
      color: var(--muted); pointer-events:none;
    }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
    .btn {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: background .2s, transform .1s;
    }
    .btn:active { transform: scale(.98); }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: var(--primary-dk); }
    .btn-primary:disabled { background: #93c5fd; cursor: not-allowed; }
    .btn-secondary { background: #e2e8f0; color: var(--text); }
    .btn-secondary:hover { background: #cbd5e1; }
    .alert {
      padding: 10px 14px;
      border-radius: 8px;
      font-size: .875rem;
      margin-bottom: 16px;
      display: none;
    }
    .alert.error   { background:#fee2e2; color:#b91c1c; border:1px solid #fca5a5; display:block; }
    .alert.success { background:#dcfce7; color:#15803d; border:1px solid #86efac; display:block; }
    .divider { border:none; border-top:1px solid var(--border); margin:20px 0; }
    .badge {
      display:inline-block;
      background:#eff6ff;
      color:var(--primary);
      font-size:.75rem;
      font-weight:700;
      padding:2px 8px;
      border-radius:99px;
      margin-left:6px;
    }
    .spinner {
      display:inline-block;
      width:16px; height:16px;
      border:2px solid rgba(255,255,255,.4);
      border-top-color:#fff;
      border-radius:50%;
      animation:spin .6s linear infinite;
      vertical-align:middle;
      margin-right:6px;
    }
    @keyframes spin { to { transform:rotate(360deg); } }
    .hidden { display: none !important; }
    .user-bar {
      display:flex; align-items:center; justify-content:space-between;
      background:#eff6ff; border-radius:8px; padding:10px 14px;
      margin-bottom:20px; font-size:.875rem;
    }
    .user-bar strong { color:var(--primary); }
    .user-bar button {
      background:none; border:none; color:var(--danger);
      font-size:.8125rem; font-weight:600; cursor:pointer;
    }
    .user-bar button:hover { text-decoration:underline; }
    .file-label {
      display:flex; align-items:center; gap:10px;
      border:1.5px dashed var(--border);
      border-radius:8px; padding:10px 14px;
      cursor:pointer; transition:border-color .2s;
      font-size:.9rem; color:var(--muted);
    }
    .file-label:hover { border-color:var(--primary); color:var(--primary); }
    .file-label input[type="file"] { display:none; }
    #firma-name { font-size:.8rem; color:var(--muted); margin-top:4px; }
    .selector-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 24px;
    }
    .selector-btn {
      padding: 14px;
      border: 2px solid var(--border);
      border-radius: 8px;
      background: #fff;
      cursor: pointer;
      transition: all .2s;
      text-align: center;
      font-weight: 600;
      font-size: .9rem;
      color: var(--muted);
    }
    .selector-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }
    .selector-btn.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }
  </style>
</head>
<body>
<div class="card" id="app">

  <!-- LOGIN -->
  <div id="screen-login">
    <div class="card-header">
      <div class="logo">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2a9 9 0 0 1 9 9v1H3v-1a9 9 0 0 1 9-9zm-9 11h18v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1zm2 4h14v1a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1v-1z"/>
        </svg>
      </div>
      <h1>Permisos de Trabajo</h1>
      <p>Inicia sesion para continuar</p>
    </div>
    <div id="login-alert" class="alert"></div>
    <form id="form-login" novalidate>
      <div class="form-group">
        <label for="login-user">Usuario</label>
        <div class="input-icon">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/></svg>
          </span>
          <input type="text" id="login-user" placeholder="Ingresa tu usuario" autocomplete="username" required />
        </div>
      </div>
      <div class="form-group">
        <label for="login-pass">Contrasena</label>
        <div class="input-icon">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
          </span>
          <input type="password" id="login-pass" placeholder="Ingresa tu contrasena" autocomplete="current-password" required />
        </div>
      </div>
      <button type="submit" class="btn btn-primary" id="btn-login">Iniciar sesion</button>
    </form>
    <hr class="divider" />
    <p style="text-align:center;font-size:.8rem;color:var(--muted);">
      Credenciales de prueba: <strong>admin</strong> / <strong>1234</strong>
    </p>
  </div>

  <!-- SELECTOR DE FORMULARIOS -->
  <div id="screen-selector" class="hidden">
    <div class="user-bar">
      <span>Bienvenido, <strong id="user-name-display-selector"></strong></span>
      <button id="btn-logout-selector">Cerrar sesion</button>
    </div>
    <div class="card-header" style="margin-bottom:20px;">
      <h1>Selecciona un Formulario</h1>
      <p>Elige el tipo de documento que deseas generar</p>
    </div>
    <div class="selector-container">
      <button type="button" class="selector-btn active" id="btn-select-alturas">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin: 0 auto 8px; display: block;">
          <path d="M12 2v20M2 12h20"/>
        </svg>
        Permiso de Alturas
      </button>
      <button type="button" class="selector-btn" id="btn-select-asistencia">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin: 0 auto 8px; display: block;">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2M12 3a4 4 0 1 0 0 8 4 4 0 0 0 0-8z"/>
        </svg>
        Asistencia
      </button>
    </div>
  </div>

  <!-- FORMULARIO DE ALTURAS -->
  <div id="screen-form-alturas" class="hidden">
    <div class="user-bar">
      <span>Bienvenido, <strong id="user-name-display-alturas"></strong></span>
      <button id="btn-back-alturas">Volver</button>
    </div>
    <div class="card-header" style="margin-bottom:20px;">
      <h1>Permiso de Trabajo en Alturas <span class="badge">Excel</span></h1>
      <p>Completa los campos y descarga el documento generado</p>
    </div>
    <div id="form-alert-alturas" class="alert"></div>
    <form id="form-permiso-alturas" novalidate>
      <div class="row">
        <div class="form-group">
          <label for="f-fecha">Fecha</label>
          <input type="date" id="f-fecha" required />
        </div>
        <div class="form-group">
          <label for="f-hora">Hora de inicio</label>
          <input type="time" id="f-hora" required />
        </div>
      </div>
      <div class="form-group">
        <label for="f-area">Area / Ubicacion</label>
        <input type="text" id="f-area" placeholder="Ej: Torre A, Piso 3" required />
      </div>
      <div class="form-group">
        <label for="f-altura">Altura maxima (metros)</label>
        <input type="number" id="f-altura" placeholder="Ej: 15" min="0" step="0.1" required />
      </div>
      <div class="form-group">
        <label>Firma del responsable</label>
        <label class="file-label" for="f-firma">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
          Seleccionar imagen de firma
          <input type="file" id="f-firma" accept="image/*" />
        </label>
        <div id="firma-name">Sin archivo seleccionado (se usara firma1.png por defecto)</div>
      </div>
      <button type="submit" class="btn btn-primary" id="btn-generar-alturas">
        Generar y descargar Excel
      </button>
    </form>
  </div>

  <!-- FORMULARIO DE ASISTENCIA -->
  <div id="screen-form-asistencia" class="hidden">
    <div class="user-bar">
      <span>Bienvenido, <strong id="user-name-display-asistencia"></strong></span>
      <button id="btn-back-asistencia">Volver</button>
    </div>
    <div class="card-header" style="margin-bottom:20px;">
      <h1>Registro de Asistencia <span class="badge">Nuevo</span></h1>
      <p>Completa los campos de asistencia</p>
    </div>
    <div id="form-alert-asistencia" class="alert"></div>
    <form id="form-asistencia" novalidate>
      <div class="row">
        <div class="form-group">
          <label for="a-fecha">Fecha</label>
          <input type="date" id="a-fecha" required />
        </div>
        <div class="form-group">
          <label for="a-hora-entrada">Hora de entrada</label>
          <input type="time" id="a-hora-entrada" required />
        </div>
      </div>
      <div class="row">
        <div class="form-group">
          <label for="a-hora-salida">Hora de salida</label>
          <input type="time" id="a-hora-salida" required />
        </div>
        <div class="form-group">
          <label for="a-trabajador">Nombre del trabajador</label>
          <input type="text" id="a-trabajador" placeholder="Ej: Juan Pérez" required />
        </div>
      </div>
      <div class="form-group">
        <label for="a-departamento">Departamento</label>
        <input type="text" id="a-departamento" placeholder="Ej: Mantenimiento" required />
      </div>
      <div class="form-group">
        <label for="a-observaciones">Observaciones</label>
        <textarea id="a-observaciones" placeholder="Notas adicionales (opcional)"></textarea>
      </div>
      <button type="submit" class="btn btn-primary" id="btn-generar-asistencia">
        Guardar asistencia
      </button>
    </form>
  </div>

</div>
<script>
  var USERS = [
    { username: 'admin',    password: '1234',   displayName: 'Administrador' },
    { username: 'operador', password: 'op2024', displayName: 'Operador'      }
  ];
  var API_BASE = 'http://localhost:5205';
  var currentUser = null;
  var currentForm = null; // 'alturas' o 'asistencia'

  function gid(id) { return document.getElementById(id); }

  function showAlert(id, msg, type) {
    var el = gid(id);
    el.textContent = msg;
    el.className = 'alert ' + type;
  }
  function hideAlert(id) {
    var el = gid(id);
    el.className = 'alert';
    el.textContent = '';
  }
  function showScreen(name) {
    gid('screen-login').classList.toggle('hidden', name !== 'login');
    gid('screen-selector').classList.toggle('hidden', name !== 'selector');
    gid('screen-form-alturas').classList.toggle('hidden', name !== 'alturas');
    gid('screen-form-asistencia').classList.toggle('hidden', name !== 'asistencia');
  }

  function tryRestoreSession() {
    var saved = sessionStorage.getItem('currentUser');
    if (saved) {
      currentUser = JSON.parse(saved);
      gid('user-name-display-selector').textContent = currentUser.displayName;
      gid('user-name-display-alturas').textContent = currentUser.displayName;
      gid('user-name-display-asistencia').textContent = currentUser.displayName;
      showScreen('selector');
    } else {
      showScreen('login');
    }
  }

  // LOGIN
  gid('form-login').addEventListener('submit', function(e) {
    e.preventDefault();
    hideAlert('login-alert');
    var username = gid('login-user').value.trim();
    var password = gid('login-pass').value;
    var user = USERS.find(function(u) { return u.username === username && u.password === password; });
    if (!user) {
      showAlert('login-alert', 'Usuario o contrasena incorrectos.', 'error');
      return;
    }
    currentUser = user;
    sessionStorage.setItem('currentUser', JSON.stringify(user));
    gid('user-name-display-selector').textContent = user.displayName;
    gid('user-name-display-alturas').textContent = user.displayName;
    gid('user-name-display-asistencia').textContent = user.displayName;
    showScreen('selector');
  });

  // SELECTOR - Botones para elegir formulario
  gid('btn-select-alturas').addEventListener('click', function() {
    gid('btn-select-alturas').classList.add('active');
    gid('btn-select-asistencia').classList.remove('active');
    currentForm = 'alturas';
    var today = new Date().toISOString().split('T')[0];
    gid('f-fecha').value = today;
    showScreen('alturas');
  });

  gid('btn-select-asistencia').addEventListener('click', function() {
    gid('btn-select-asistencia').classList.add('active');
    gid('btn-select-alturas').classList.remove('active');
    currentForm = 'asistencia';
    var today = new Date().toISOString().split('T')[0];
    gid('a-fecha').value = today;
    showScreen('asistencia');
  });

  // BOTONES VOLVER
  gid('btn-back-alturas').addEventListener('click', function() {
    showScreen('selector');
  });

  gid('btn-back-asistencia').addEventListener('click', function() {
    showScreen('selector');
  });

  // LOGOUT
  function logout() {
    currentUser = null;
    currentForm = null;
    sessionStorage.removeItem('currentUser');
    gid('form-login').reset();
    gid('form-permiso-alturas').reset();
    gid('form-asistencia').reset();
    gid('firma-name').textContent = 'Sin archivo seleccionado (se usara firma1.png por defecto)';
    hideAlert('form-alert-alturas');
    hideAlert('form-alert-asistencia');
    showScreen('login');
  }

  gid('btn-logout-selector').addEventListener('click', logout);

  // FIRMA (para formulario de alturas)
  gid('f-firma').addEventListener('change', function() {
    var file = this.files[0];
    gid('firma-name').textContent = file ? file.name : 'Sin archivo seleccionado (se usara firma1.png por defecto)';
  });

  // FORMULARIO ALTURAS
  gid('form-permiso-alturas').addEventListener('submit', async function(e) {
    e.preventDefault();
    hideAlert('form-alert-alturas');
    var btn = gid('btn-generar-alturas');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span>Generando...';
    var firmaFile = gid('f-firma').files[0];
    var firmaName = firmaFile ? firmaFile.name : 'firma1.png';
    var payload = {
      fecha:                    gid('f-fecha').value,
      horaInicio:               gid('f-hora').value,
      area:                     gid('f-area').value,
      alturaMaxima:             gid('f-altura').value,
      imgFirmaResponsableTarea: firmaName
    };
    try {
      var response = await fetch(API_BASE + '/api/documentos/generar-permiso', {
        method:  'POST',
        headers: { 'Content-Type': 'application/json' },
        body:    JSON.stringify(payload)
      });
      if (!response.ok) {
        var errText = await response.text();
        throw new Error(errText || 'Error ' + response.status);
      }
      var blob = await response.blob();
      var url  = window.URL.createObjectURL(blob);
      var a    = document.createElement('a');
      a.href     = url;
      a.download = 'Permiso_Alturas_Completado.xlsx';
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
      showAlert('form-alert-alturas', 'Documento generado y descargado correctamente.', 'success');
    } catch (err) {
      showAlert('form-alert-alturas',
        'No se pudo conectar con el servidor. Verifica que el backend este corriendo en ' + API_BASE + '. Detalle: ' + err.message,
        'error'
      );
    } finally {
      btn.disabled = false;
      btn.innerHTML = 'Generar y descargar Excel';
    }
  });

  // FORMULARIO ASISTENCIA
  gid('form-asistencia').addEventListener('submit', async function(e) {
    e.preventDefault();
    hideAlert('form-alert-asistencia');
    var btn = gid('btn-generar-asistencia');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span>Guardando...';
    var payload = {
      fecha:          gid('a-fecha').value,
      horaEntrada:    gid('a-hora-entrada').value,
      horaSalida:     gid('a-hora-salida').value,
      trabajador:     gid('a-trabajador').value,
      departamento:   gid('a-departamento').value,
      observaciones:  gid('a-observaciones').value
    };
    try {
      // Por ahora solo mostramos un mensaje de éxito
      // Cuando tengas el endpoint en el backend, descomenta esto:
      /*
      var response = await fetch(API_BASE + '/api/documentos/guardar-asistencia', {
        method:  'POST',
        headers: { 'Content-Type': 'application/json' },
        body:    JSON.stringify(payload)
      });
      if (!response.ok) {
        var errText = await response.text();
        throw new Error(errText || 'Error ' + response.status);
      }
      */
      showAlert('form-alert-asistencia', 'Asistencia registrada correctamente.', 'success');
      gid('form-asistencia').reset();
      var today = new Date().toISOString().split('T')[0];
      gid('a-fecha').value = today;
    } catch (err) {
      showAlert('form-alert-asistencia',
        'Error al guardar la asistencia. Detalle: ' + err.message,
        'error'
      );
    } finally {
      btn.disabled = false;
      btn.innerHTML = 'Guardar asistencia';
    }
  });

  tryRestoreSession();
</script>
</body>
</html>
