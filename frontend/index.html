<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Permisos de Trabajo</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --primary: #1a56db; --primary-dk: #1240a8;
      --bg: #f1f5f9; --card: #ffffff; --text: #1e293b;
      --muted: #64748b; --border: #cbd5e1; --danger: #ef4444;
      --radius: 10px;
    }
    body { font-family:'Segoe UI',Arial,sans-serif; background:var(--bg); color:var(--text); min-height:100vh; display:flex; align-items:center; justify-content:center; }
    .card { background:var(--card); border-radius:var(--radius); box-shadow:0 4px 24px rgba(0,0,0,.10); width:100%; max-width:520px; padding:40px 36px; animation:fadeIn .35s ease; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:none} }
    .card-header { text-align:center; margin-bottom:28px; }
    .card-header .logo { width:56px;height:56px;background:var(--primary);border-radius:14px;display:inline-flex;align-items:center;justify-content:center;margin-bottom:14px; }
    .card-header .logo svg { width:30px;height:30px;fill:#fff; }
    .card-header h1 { font-size:1.35rem;font-weight:700; }
    .card-header p  { font-size:.875rem;color:var(--muted);margin-top:4px; }
    .form-group { margin-bottom:18px; }
    .form-group label { display:block;font-size:.8125rem;font-weight:600;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:.04em; }
    .form-group input, .form-group textarea { width:100%;padding:10px 14px;border:1.5px solid var(--border);border-radius:8px;font-size:.9375rem;color:var(--text);background:#fff;outline:none;font-family:inherit;transition:border-color .2s,box-shadow .2s; }
    .form-group input:focus, .form-group textarea:focus { border-color:var(--primary);box-shadow:0 0 0 3px rgba(26,86,219,.12); }
    .form-group textarea { resize:vertical;min-height:80px; }
    .input-icon { position:relative; }
    .input-icon input { padding-left:40px; }
    .input-icon .icon { position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--muted);pointer-events:none; }
    .row { display:grid;grid-template-columns:1fr 1fr;gap:14px; }
    .btn { width:100%;padding:12px;border:none;border-radius:8px;font-size:1rem;font-weight:700;cursor:pointer;transition:background .2s,transform .1s; }
    .btn:active { transform:scale(.98); }
    .btn-primary { background:var(--primary);color:#fff; }
    .btn-primary:hover { background:var(--primary-dk); }
    .btn-primary:disabled { background:#93c5fd;cursor:not-allowed; }
    .alert { padding:10px 14px;border-radius:8px;font-size:.875rem;margin-bottom:16px;display:none; }
    .alert.error   { background:#fee2e2;color:#b91c1c;border:1px solid #fca5a5;display:block; }
    .alert.success { background:#dcfce7;color:#15803d;border:1px solid #86efac;display:block; }
    .divider { border:none;border-top:1px solid var(--border);margin:20px 0; }
    .badge { display:inline-block;background:#eff6ff;color:var(--primary);font-size:.75rem;font-weight:700;padding:2px 8px;border-radius:99px;margin-left:6px; }
    .spinner { display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,.4);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite;vertical-align:middle;margin-right:6px; }
    @keyframes spin { to{transform:rotate(360deg)} }
    .hidden { display:none !important; }
    .user-bar { display:flex;align-items:center;justify-content:space-between;background:#eff6ff;border-radius:8px;padding:10px 14px;margin-bottom:20px;font-size:.875rem; }
    .user-bar strong { color:var(--primary); }
    .user-bar button { background:none;border:none;color:var(--danger);font-size:.8125rem;font-weight:600;cursor:pointer; }
    .user-bar button:hover { text-decoration:underline; }
    .selector-container { display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:24px; }
    .selector-btn { padding:14px;border:2px solid var(--border);border-radius:8px;background:#fff;cursor:pointer;transition:all .2s;text-align:center;font-weight:600;font-size:.9rem;color:var(--muted); }
    .selector-btn:hover { border-color:var(--primary);color:var(--primary); }
    .firma-container { border:1.5px solid var(--border);border-radius:8px;overflow:hidden;background:#fff; }
    .firma-container canvas { display:block;width:100%;height:120px;cursor:crosshair;touch-action:none;background:#fff; }
    .firma-toolbar { display:flex;justify-content:flex-end;gap:8px;padding:6px 10px;background:#f8fafc;border-top:1px solid var(--border); }
    .firma-toolbar button { padding:4px 12px;border:1px solid var(--border);border-radius:6px;background:#fff;font-size:.8rem;cursor:pointer;color:var(--muted);font-weight:600; }
    .firma-toolbar button:hover { border-color:var(--primary);color:var(--primary); }
    .firma-hint { font-size:.75rem;color:var(--muted);margin-top:4px; }
  </style>
</head>
<body>
<div class="card">

  <!-- LOGIN -->
  <div id="screen-login">
    <div class="card-header">
      <div class="logo"><svg viewBox="0 0 24 24"><path d="M12 2a9 9 0 0 1 9 9v1H3v-1a9 9 0 0 1 9-9zm-9 11h18v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1zm2 4h14v1a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1v-1z"/></svg></div>
      <h1>Permisos de Trabajo</h1>
      <p>Inicia sesion para continuar</p>
    </div>
    <div id="login-alert" class="alert"></div>
    <form id="form-login" novalidate>
      <div class="form-group">
        <label>Usuario</label>
        <div class="input-icon">
          <span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/></svg></span>
          <input type="text" id="login-user" placeholder="Ingresa tu usuario" autocomplete="username" required />
        </div>
      </div>
      <div class="form-group">
        <label>Contrasena</label>
        <div class="input-icon">
          <span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg></span>
          <input type="password" id="login-pass" placeholder="Ingresa tu contrasena" autocomplete="current-password" required />
        </div>
      </div>
      <button type="submit" class="btn btn-primary" id="btn-login">Iniciar sesion</button>
    </form>
    <hr class="divider" />
    <p style="text-align:center;font-size:.8rem;color:var(--muted);">Credenciales de prueba: <strong>admin</strong> / <strong>1234</strong></p>
  </div>

  <!-- SELECTOR -->
  <div id="screen-selector" class="hidden">
    <div class="user-bar">
      <span>Bienvenido, <strong id="user-display-selector"></strong></span>
      <button id="btn-logout">Cerrar sesion</button>
    </div>
    <div class="card-header" style="margin-bottom:20px;">
      <h1>Selecciona un Formulario</h1>
      <p>Elige el tipo de documento que deseas generar</p>
    </div>
    <div class="selector-container">
      <button type="button" class="selector-btn" id="btn-ir-alturas">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin:0 auto 8px;display:block;"><path d="M12 2v20M2 12h20"/></svg>
        Permiso de Alturas
      </button>
      <button type="button" class="selector-btn" id="btn-ir-asistencia">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin:0 auto 8px;display:block;"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2M12 3a4 4 0 1 0 0 8 4 4 0 0 0 0-8z"/></svg>
        Asistencia
      </button>
    </div>
  </div>

  <!-- ALTURAS -->
  <div id="screen-alturas" class="hidden">
    <div class="user-bar">
      <span>Bienvenido, <strong id="user-display-alturas"></strong></span>
      <button id="btn-back-alturas">Volver</button>
    </div>
    <div class="card-header" style="margin-bottom:20px;">
      <h1>Permiso de Trabajo en Alturas <span class="badge">Excel</span></h1>
      <p>Completa los campos y descarga el documento generado</p>
    </div>
    <div id="alert-alturas" class="alert"></div>
    <form id="form-alturas" novalidate>
      <div class="row">
        <div class="form-group"><label>Fecha</label><input type="date" id="f-fecha" required /></div>
        <div class="form-group"><label>Hora de inicio</label><input type="time" id="f-hora" required /></div>
      </div>
      <div class="form-group"><label>Area / Ubicacion</label><input type="text" id="f-area" placeholder="Ej: Torre A, Piso 3" required /></div>
      <div class="form-group"><label>Altura maxima (metros)</label><input type="number" id="f-altura" placeholder="Ej: 15" min="0" required /></div>
      <div class="form-group">
        <label>Firma del responsable</label>
        <div class="firma-container">
          <canvas id="firma-canvas" width="480" height="120"></canvas>
          <div class="firma-toolbar"><button type="button" id="btn-limpiar-firma">Limpiar</button></div>
        </div>
        <p class="firma-hint">Dibuja tu firma con el mouse o dedo en el area de arriba.</p>
      </div>
      <button type="submit" class="btn btn-primary" id="btn-generar-alturas">Generar y descargar Excel</button>
    </form>
  </div>

  <!-- ASISTENCIA -->
  <div id="screen-asistencia" class="hidden">
    <div class="user-bar">
      <span>Bienvenido, <strong id="user-display-asistencia"></strong></span>
      <button id="btn-back-asistencia">Volver</button>
    </div>
    <div class="card-header" style="margin-bottom:20px;">
      <h1>Registro de Asistencia <span class="badge">Excel</span></h1>
      <p>Completa los campos y descarga el documento generado</p>
    </div>
    <div id="alert-asistencia" class="alert"></div>
    <form id="form-asistencia" novalidate>
      <div class="row">
        <div class="form-group"><label>Fecha</label><input type="date" id="a-fecha" required /></div>
        <div class="form-group"><label>Hora de entrada</label><input type="time" id="a-hora-entrada" required /></div>
      </div>
      <div class="row">
        <div class="form-group"><label>Hora de salida</label><input type="time" id="a-hora-salida" required /></div>
        <div class="form-group"><label>Nombre del trabajador</label><input type="text" id="a-trabajador" placeholder="Ej: Juan Perez" required /></div>
      </div>
      <div class="form-group"><label>Departamento</label><input type="text" id="a-departamento" placeholder="Ej: Mantenimiento" required /></div>
      <div class="form-group"><label>Observaciones</label><textarea id="a-observaciones" placeholder="Notas adicionales (opcional)"></textarea></div>
      <button type="submit" class="btn btn-primary" id="btn-generar-asistencia">Generar y descargar Excel</button>
    </form>
  </div>

</div>
<script>
var API_BASE = 'http://localhost:5205';

// ── JWT en localStorage ──────────────────────────────────────
function getToken()  { return localStorage.getItem('jwt_token'); }
function setToken(t) { localStorage.setItem('jwt_token', t); }
function clearAuth() { localStorage.removeItem('jwt_token'); localStorage.removeItem('jwt_user'); }
function getUser()   { try { return JSON.parse(localStorage.getItem('jwt_user')); } catch(e) { return null; } }
function setUser(u)  { localStorage.setItem('jwt_user', JSON.stringify(u)); }

function authHeaders() {
  var h = { 'Content-Type': 'application/json' };
  var t = getToken();
  if (t) h['Authorization'] = 'Bearer ' + t;
  return h;
}

// ── DOM helpers ──────────────────────────────────────────────
function gid(id) { return document.getElementById(id); }
function showAlert(id, msg, type) { var el=gid(id); el.textContent=msg; el.className='alert '+type; }
function hideAlert(id) { var el=gid(id); el.className='alert'; el.textContent=''; }
function showScreen(name) {
  ['login','selector','alturas','asistencia'].forEach(function(s) {
    gid('screen-'+s).classList.toggle('hidden', s !== name);
  });
}
function setUserDisplay(dn) {
  ['selector','alturas','asistencia'].forEach(function(s) {
    gid('user-display-'+s).textContent = dn;
  });
}

// ── Canvas de Firma Digital ──────────────────────────────────
// Captura el trazo del usuario y genera un string Base64 PNG.
// El backend lo recibe, lo decodifica y lo inyecta en el Excel
// con worksheet.AddPicture() — nunca se guarda en disco.
var canvas = gid('firma-canvas');
var ctx    = canvas.getContext('2d');
var drawing = false, empty = true;
ctx.strokeStyle='#1e293b'; ctx.lineWidth=2.5; ctx.lineCap='round'; ctx.lineJoin='round';

function pos(e) {
  var r=canvas.getBoundingClientRect(), sx=canvas.width/r.width, sy=canvas.height/r.height;
  var s=e.touches?e.touches[0]:e;
  return { x:(s.clientX-r.left)*sx, y:(s.clientY-r.top)*sy };
}
canvas.addEventListener('mousedown',  function(e){ drawing=true; empty=false; var p=pos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y); });
canvas.addEventListener('mousemove',  function(e){ if(!drawing)return; var p=pos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); });
canvas.addEventListener('mouseup',    function(){ drawing=false; });
canvas.addEventListener('mouseleave', function(){ drawing=false; });
canvas.addEventListener('touchstart', function(e){ e.preventDefault(); drawing=true; empty=false; var p=pos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y); },{passive:false});
canvas.addEventListener('touchmove',  function(e){ e.preventDefault(); if(!drawing)return; var p=pos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); },{passive:false});
canvas.addEventListener('touchend',   function(){ drawing=false; });
gid('btn-limpiar-firma').addEventListener('click', function(){ ctx.clearRect(0,0,canvas.width,canvas.height); empty=true; });
function getFirmaBase64() { return empty ? null : canvas.toDataURL('image/png'); }

// ── Autenticacion ────────────────────────────────────────────
function tryRestoreSession() {
  var token=getToken(), user=getUser();
  if (token && user) { setUserDisplay(user.displayName); showScreen('selector'); }
  else showScreen('login');
}

gid('form-login').addEventListener('submit', async function(e) {
  e.preventDefault();
  hideAlert('login-alert');
  var btn=gid('btn-login');
  btn.disabled=true; btn.innerHTML='<span class="spinner"></span>Ingresando...';
  try {
    var res = await fetch(API_BASE+'/api/auth/login', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ username:gid('login-user').value.trim(), password:gid('login-pass').value })
    });
    if (!res.ok) {
      var err = await res.json().catch(function(){ return {message:'Credenciales incorrectas.'}; });
      throw new Error(err.message||'Error de autenticacion');
    }
    var data = await res.json();
    setToken(data.token);
    setUser({ username:data.username, displayName:data.displayName });
    setUserDisplay(data.displayName);
    showScreen('selector');
  } catch(err) {
    var msg = err.message;
    if (msg.toLowerCase().includes('fetch')||msg.toLowerCase().includes('failed'))
      msg = 'No se pudo conectar al servidor ('+API_BASE+'). Verifica que el backend este corriendo con "dotnet run".';
    showAlert('login-alert', msg, 'error');
  } finally {
    btn.disabled=false; btn.innerHTML='Iniciar sesion';
  }
});

function logout() {
  clearAuth();
  gid('form-login').reset(); gid('form-alturas').reset(); gid('form-asistencia').reset();
  ctx.clearRect(0,0,canvas.width,canvas.height); empty=true;
  hideAlert('alert-alturas'); hideAlert('alert-asistencia');
  showScreen('login');
}
gid('btn-logout').addEventListener('click', logout);

// ── Navegacion ───────────────────────────────────────────────
gid('btn-ir-alturas').addEventListener('click', function(){
  gid('f-fecha').value = new Date().toISOString().split('T')[0];
  showScreen('alturas');
});
gid('btn-ir-asistencia').addEventListener('click', function(){
  gid('a-fecha').value = new Date().toISOString().split('T')[0];
  showScreen('asistencia');
});
gid('btn-back-alturas').addEventListener('click',    function(){ showScreen('selector'); });
gid('btn-back-asistencia').addEventListener('click', function(){ showScreen('selector'); });

// ── Motor agnostico: unica funcion para llamar al unico endpoint ──
// POST /api/documentos/generar
// Body: { plantilla, hoja, datos }
// "datos" es un JSON libre: las llaves deben coincidir con
// los {{placeholders}} que esten en la plantilla Excel.
async function generarDocumento(plantilla, hoja, datos, nombreArchivo, alertId, btnId, btnLabel) {
  hideAlert(alertId);
  var btn=gid(btnId);
  btn.disabled=true; btn.innerHTML='<span class="spinner"></span>Generando...';
  try {
    var res = await fetch(API_BASE+'/api/documentos/generar', {
      method:'POST',
      headers: authHeaders(),
      body: JSON.stringify({ plantilla:plantilla, hoja:hoja, datos:datos })
    });
    if (res.status===401) {
      showAlert(alertId,'Sesion expirada. Redirigiendo al login...','error');
      setTimeout(logout, 2000); return;
    }
    if (!res.ok) { var t=await res.text(); throw new Error(t||'Error '+res.status); }
    var blob=await res.blob();
    var url=window.URL.createObjectURL(blob);
    var a=document.createElement('a'); a.href=url; a.download=nombreArchivo;
    document.body.appendChild(a); a.click(); a.remove();
    window.URL.revokeObjectURL(url);
    showAlert(alertId,'Documento generado y descargado correctamente.','success');
  } catch(err) {
    showAlert(alertId,'Error al conectar con el servidor. Detalle: '+err.message,'error');
  } finally {
    btn.disabled=false; btn.innerHTML=btnLabel;
  }
}

// ── Formulario Alturas ───────────────────────────────────────
// Las llaves de "datos" deben coincidir con los {{placeholders}}
// del archivo ALTURAS.xlsx. No hay modelo fijo en el backend.
gid('form-alturas').addEventListener('submit', async function(e) {
  e.preventDefault();
  var datos = {
    fecha_permiso: gid('f-fecha').value,
    hora_inicio:   gid('f-hora').value,
    area_trabajo:  gid('f-area').value,
    altura_maxima: gid('f-altura').value
  };
  var firma = getFirmaBase64();
  if (firma) datos['firma_responsable'] = { firma_base64: firma };

  await generarDocumento(
    'ALTURAS.xlsx', 'Permiso de trabajo', datos,
    'Permiso_Alturas_Generado.xlsx',
    'alert-alturas', 'btn-generar-alturas', 'Generar y descargar Excel'
  );
});

// ── Formulario Asistencia ────────────────────────────────────
// Mismo motor, diferente plantilla y diferentes llaves.
// Solo hay que tener ASISTENCIA.xlsx en Templates/ con los
// {{placeholders}} correspondientes.
gid('form-asistencia').addEventListener('submit', async function(e) {
  e.preventDefault();
  var datos = {
    fecha:             gid('a-fecha').value,
    hora_entrada:      gid('a-hora-entrada').value,
    hora_salida:       gid('a-hora-salida').value,
    nombre_trabajador: gid('a-trabajador').value,
    departamento:      gid('a-departamento').value,
    observaciones:     gid('a-observaciones').value
  };
  await generarDocumento(
    'ASISTENCIA.xlsx', 'Asistencia', datos,
    'Asistencia_Generada.xlsx',
    'alert-asistencia', 'btn-generar-asistencia', 'Generar y descargar Excel'
  );
});

// ── Inicio ───────────────────────────────────────────────────
tryRestoreSession();
</script>
</body>
</html>
